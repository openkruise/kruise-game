name: E2E-1.30

on:
  push:
    branches:
      - master
      - release-*
  pull_request: {}
  workflow_dispatch: {}

env:
  # Common versions
  GO_VERSION: '1.23.4'
  KIND_VERSION: 'v0.22.0'
  KIND_IMAGE: 'kindest/node:v1.30.8'
  KIND_CLUSTER_NAME: 'ci-testing'
  CERT_MANAGER_VERSION: 'v1.18.2'

jobs:

  game-kruise:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0
          fetch-tags: true
      - name: Ensure tags are available
        run: git fetch --force --tags
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Determine build metadata
        run: |
          echo "::group::Determine build metadata"
          bash ./scripts/ci/determine-build-metadata.sh
          echo "::endgroup::"
        # Prepare audit policy before cluster creation so extraMounts can find it
      - name: Prepare audit policy
        run: |
          echo "::group::Prepare audit policy"
          bash ./scripts/ci/prepare-kind-audit.sh
          echo "::endgroup::"
      - name: Setup Kind Cluster
        uses: helm/kind-action@v1.12.0
        with:
          node_image: ${{ env.KIND_IMAGE }}
          cluster_name: ${{ env.KIND_CLUSTER_NAME }}
          config: ./test/kind-conf.yaml
          version: ${{ env.KIND_VERSION }}
      - name: Ensure audit log file exists and is world-readable
        run: |
          echo "::group::Ensure audit log file"
          bash ./scripts/ci/ensure-audit-log.sh
          echo "::endgroup::"
      - name: Build image
        run: |
          echo "::group::Build manager image"
          bash ./scripts/ci/build-manager-image.sh
          echo "::endgroup::"
      - name: Install Cert-Manager
        run: |
          echo "::group::Install Cert-Manager"
          bash ./scripts/ci/install-cert-manager.sh
          echo "::endgroup::"
      - name: Install Kruise
        run: |
          echo "::group::Install Kruise"
          bash ./scripts/ci/install-kruise.sh
          echo "::endgroup::"
      - name: Install Kruise Game in HA mode
        run: |
          echo "::group::Install Kruise Game"
          set -ex
          IMG=${E2E_IMAGE} ENABLE_HA=true ./scripts/deploy_kind.sh
          
          # Wait for the controller manager to be ready at least 1 replica
          for i in {1..30}; do
            set +e
            PODS=$(kubectl get pod -n kruise-game-system | grep '1/1' | wc -l)
            set -e
            if [ "$PODS" -eq "1" ]; then
              break
            fi
            echo "Waiting for controller ready... ($i/10)"
            sleep 3
          done

          # Verify that at least 2 controller replicas are running
          PODS=$(kubectl get pod -n kruise-game-system --selector=control-plane=controller-manager -o jsonpath='{.items..metadata.name}' | wc -w)
          if [ "$PODS" -lt "2" ]; then
            echo "HA mode requires at least 2 controller replicas, but found $PODS"
            kubectl get pod -n kruise-game-system
            exit 1
          fi
          echo "Kruise Game installed in HA mode successfully"
          echo "::endgroup::"
      - name: Verify Kind Cluster
        run: |
          echo "::group::Verify Kind cluster"
          bash ./scripts/ci/verify-kind-cluster.sh
          echo "::endgroup::"
      - name: Run E2E Tests before failover
        env:
          E2E_ARTIFACT_ROOT: /tmp/e2e-artifacts
          E2E_ARTIFACT_SUFFIX: before-ha
          E2E_AUDIT_LOG_PATH: /tmp/kind-audit/audit.log
        run: |
          echo "::group::Run E2E tests (before failover)"
          bash ./scripts/ci/run-e2e-tests.sh
          echo "::endgroup::"
      - name: Test HA Failover
        run: |
          echo "::group::Test HA failover"
          set -e
          NAMESPACE=kruise-game-system
          LEASE_NAME=game-kruise-manager
          echo "--- Identifying initial leader ---"
          LEADER_POD=$(kubectl get lease $LEASE_NAME -n $NAMESPACE -o jsonpath='{.spec.holderIdentity}' | awk -F'_' '{print $1}')
          if [ -z "$LEADER_POD" ]; then
            echo "Could not determine leader pod."
            exit 1
          fi
          echo "Current leader is $LEADER_POD"

          echo "--- Deleting leader pod to trigger failover ---"
          kubectl delete pod $LEADER_POD -n $NAMESPACE
          
          echo "--- Waiting for new leader to be elected ---"
          for i in {1..30}; do
            NEW_LEADER_POD=$(kubectl get lease $LEASE_NAME -n $NAMESPACE -o jsonpath='{.spec.holderIdentity}' | awk -F'_' '{print $1}')
            if [ -n "$NEW_LEADER_POD" ] && [ "$NEW_LEADER_POD" != "$LEADER_POD" ]; then
              echo "New leader elected: $NEW_LEADER_POD"
              break
            fi
            echo "Waiting for new leader... ($i/30)"
            sleep 5
          done

          if [ "$NEW_LEADER_POD" == "$LEADER_POD" ] || [ -z "$NEW_LEADER_POD" ]; then
            echo "Failover failed. A new leader was not elected in time."
            kubectl get lease $LEASE_NAME -n $NAMESPACE -o yaml
            exit 1
          fi

          echo "--- Verifying all controller pods are ready after failover ---"
          # Wait for the controller manager to be ready at least 1 replica
          for i in {1..30}; do
            set +e
            PODS=$(kubectl get pod -n kruise-game-system | grep '1/1' | wc -l)
            set -e
            if [ "$PODS" -eq "1" ]; then
              break
            fi
            echo "Waiting for controller ready... ($i/10)"
            sleep 3
          done
          echo "HA Failover successful."
          echo "::endgroup::"
      - name: Run E2E Tests after failover
        env:
          E2E_ARTIFACT_ROOT: /tmp/e2e-artifacts
          E2E_ARTIFACT_SUFFIX: after-ha
          E2E_AUDIT_LOG_PATH: /tmp/kind-audit/audit.log
          E2E_GINKGO_FLAGS: "-v"
          E2E_MAX_RESTARTS: "1"
        run: |
          echo "::group::Run E2E tests (after failover)"
          bash ./scripts/ci/run-e2e-tests.sh
          echo "::endgroup::"
      - name: Collect Additional Diagnostics
        if: always()
        env:
          E2E_ARTIFACT_ROOT: /tmp/e2e-artifacts
        run: |
          echo "::group::Collect E2E diagnostics"
          bash ./scripts/ci/collect-e2e-artifacts.sh
          echo "::endgroup::"
      - name: Upload E2E Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-artifacts-${{ env.KIND_VERSION }}
          path: /tmp/e2e-artifacts
          if-no-files-found: warn
          retention-days: 7
          compression-level: 6
